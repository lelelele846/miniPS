# miniPE - Android 图片编辑器基础项目报告

## 一、项目概述

### 1.1 项目简介

miniPE 是一个功能强大的 Android 小型修图软件，提供了完整的图片编辑功能。项目采用模块化设计，将核心编辑功能封装为独立的 SDK 模块（`photoeditor`），应用层（`app`）负责 UI 交互和业务逻辑。

### 1.2 项目信息

- **项目名称**: miniPE
- **开发语言**: Kotlin 2.0.0
- **最低支持版本**: Android 5.0 (API 21)
- **目标版本**: Android 14 (API 34)
- **项目版本**: 3.0.2
- **构建工具**: Gradle 8.5.1

### 1.3 核心功能

- **画笔绘制** - 支持多种画笔样式（普通、箭头、线条、矩形、椭圆）、颜色、大小和透明度
- **滤镜效果** - 内置多种滤镜，支持自定义滤镜，使用 OpenGL ES GPU 加速
- **文字编辑** - 添加和编辑文字，支持自定义字体、颜色、样式、阴影、边框
- **表情符号** - 添加表情符号，支持自定义表情字体
- **贴纸功能** - 添加图片和贴纸，支持拖拽、缩放、旋转
- **图片裁剪** - 支持自由比例和固定比例裁剪，支持旋转
- **渐变遮罩** - 为图片添加渐变遮罩效果
- **撤销重做** - 支持操作的撤销和重做
- **保存分享** - 保存编辑后的图片并分享

---

## 二、整体设计

### 2.1 项目架构

项目采用**模块化分层架构**，分为两个主要模块：

```
miniPE/
├── photoeditor/          # 核心编辑 SDK 模块（Library）
│   ├── PhotoEditor       # 编辑器核心接口
│   ├── PhotoEditorImpl   # 编辑器实现类
│   ├── PhotoEditorView   # 编辑视图容器
│   ├── DrawingView       # 画笔绘制视图
│   ├── FilterImageView   # 滤镜处理视图
│   ├── GraphicManager    # 图形管理器
│   ├── PhotoEditorViewState # 状态管理
│   └── shape/            # 形状绘制模块
│
└── app/                  # 应用层模块（Application）
    ├── EditImageActivity # 主编辑界面
    ├── MediaLoader       # 媒体加载工具（优化版）
    ├── CropManager       # 裁剪管理器（单例）
    ├── PerformanceTestHelper # 性能测试工具
    ├── base/             # 基础类
    ├── filters/          # 滤镜相关
    ├── tools/            # 工具相关
    └── fragments/        # 各种功能面板
```

#### 架构特点

1. **分层设计**
   - **SDK 层** (`photoeditor`): 提供核心编辑能力，可独立发布为库
   - **应用层** (`app`): 实现 UI 交互和业务逻辑

2. **职责分离**
   - SDK 层专注于编辑功能实现（画笔、滤镜、文字、图形等）
   - 应用层负责用户交互、文件管理、性能优化、测试等

3. **可扩展性**
   - 通过接口和 Builder 模式，易于扩展新功能
   - 模块化设计便于维护和测试

### 2.2 核心模块设计

#### 2.2.1 PhotoEditor SDK 模块

**核心类结构**:

```kotlin
PhotoEditor (接口)
    └── PhotoEditorImpl (实现类)
        ├── PhotoEditorView (编辑视图容器)
        ├── DrawingView (画笔绘制)
        ├── FilterImageView (滤镜处理)
        ├── GraphicManager (图形管理)
        ├── PhotoEditorViewState (状态管理)
        └── MultiTouchListener (多指触摸处理)
```

**主要功能模块**:

1. **画笔绘制模块** (`DrawingView`)
   - 支持自由绘制
   - 支持多种画笔样式（普通、箭头、线条、矩形、椭圆）
   - 支持颜色、大小、透明度调节
   - 实现位置：`photoeditor/src/main/java/ja/miniPE/photoeditor/DrawingView.kt`

2. **滤镜模块** (`FilterImageView`)
   - 使用 OpenGL ES 进行 GPU 加速
   - 支持多种内置滤镜（`PhotoFilter` 枚举）
   - 支持自定义滤镜效果（`CustomEffect`）
   - 实现位置：`photoeditor/src/main/java/ja/miniPE/photoeditor/FilterImageView.kt`

3. **文字编辑模块** (`Text`)
   - 支持添加、编辑、删除文字
   - 支持自定义字体、颜色、样式（`TextStyleBuilder`）
   - 支持文字阴影（`TextShadow`）、边框（`TextBorder`）效果
   - 实现位置：`photoeditor/src/main/java/ja/miniPE/photoeditor/Text.kt`

4. **图形管理模块** (`GraphicManager`)
   - 管理所有编辑元素（文字、贴纸、表情、图形）
   - 支持撤销/重做操作
   - 支持元素的拖拽、缩放、旋转（`MultiTouchListener`）
   - 实现位置：`photoeditor/src/main/java/ja/miniPE/photoeditor/GraphicManager.kt`

5. **形状绘制模块** (`shape/`)
   - 抽象形状基类（`AbstractShape`）
   - 具体形状实现：线条（`LineShape`）、矩形（`RectangleShape`）、椭圆（`OvalShape`）、箭头（`BrushShape`）
   - 形状构建器（`ShapeBuilder`）

#### 2.2.2 应用层模块

**主要组件**:

1. **EditImageActivity** - 主编辑界面
   - 整合所有编辑功能
   - 管理底部工具栏和功能面板
   - 处理图片加载和保存
   - 实现位置：`app/src/main/java/com/miniPE/photoediting/EditImageActivity.kt`
   - 关键代码：
   ```kotlin
   mPhotoEditor = PhotoEditor.Builder(this, mPhotoEditorView)
       .setPinchTextScalable(pinchTextScalable)
       .build()
   ```

2. **MediaLoader** - 媒体加载工具（优化版）
   - 支持图片、GIF、WebP、视频加载
   - 大图片采样加载，避免 OOM
   - 异步加载，不阻塞 UI 线程
   - 使用 Glide 缓存机制
   - 实现位置：`app/src/main/java/com/miniPE/photoediting/MediaLoader.kt`

3. **CropManager** - 裁剪管理器（单例模式）
   - 统一的图片裁剪接口
   - 支持自由比例和固定比例裁剪
   - 支持从相机或图库选择并裁剪
   - 使用 ActivityResultLauncher 处理结果
   - 实现位置：`app/src/main/java/com/miniPE/photoediting/CropManager.kt`
   - 关键代码：
   ```kotlin
   class CropManager private constructor() {
       companion object {
           @Volatile
           private var INSTANCE: CropManager? = null
           
           fun getInstance(): CropManager {
               return INSTANCE ?: synchronized(this) {
                   INSTANCE ?: CropManager().also { INSTANCE = it }
               }
           }
       }
   }
   ```

4. **PerformanceTestHelper** - 性能测试工具
   - 对比测试优化前后的性能
   - 记录加载时间、内存占用、采样率等指标
   - 支持生成测试报告
   - 实现位置：`app/src/main/java/com/miniPE/photoediting/PerformanceTestHelper.kt`

5. **功能面板 Fragment**
   - `PropertiesBSFragment` - 画笔属性面板
   - `ShapeBSFragment` - 形状选择面板
   - `EmojiBSFragment` - 表情选择面板
   - `StickerBSFragment` - 贴纸选择面板
   - `GradientMaskBSFragment` - 渐变遮罩面板
   - `FilterViewAdapter` - 滤镜列表适配器

### 2.3 技术栈

#### 核心技术

- **语言**: Kotlin 2.0.0
- **UI 框架**: AndroidX (AppCompat 1.7.0, Material Design 1.12.0)
- **异步处理**: Kotlin Coroutines (1.8.1)
- **图片加载**: Glide 4.16.0
- **图形处理**: OpenGL ES (滤镜处理)
- **构建工具**: Gradle 8.5.1

#### 关键依赖

```gradle
// 核心依赖
implementation 'androidx.appcompat:appcompat:1.7.0'
implementation 'com.google.android.material:material:1.12.0'
implementation 'com.github.bumptech.glide:glide:4.16.0'

// 协程
implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-core:1.8.1'
implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-android:1.8.1'
```

### 2.4 设计模式

1. **Builder 模式**
   - `PhotoEditor.Builder` - 构建编辑器实例
   - `TextStyleBuilder` - 构建文字样式
   - `ShapeBuilder` - 构建图形样式
   - 代码示例：
   ```kotlin
   mPhotoEditor = PhotoEditor.Builder(this, mPhotoEditorView)
       .setPinchTextScalable(pinchTextScalable)
       .build()
   ```

2. **观察者模式**
   - `OnPhotoEditorListener` - 编辑事件监听
   - `BrushDrawingStateListener` - 画笔状态监听
   - `FilterListener` - 滤镜选择监听

3. **单例模式**
   - `CropManager` - 裁剪管理器单例
   - `MediaLoader` - 媒体加载工具单例（object）

4. **策略模式**
   - 不同滤镜效果的实现（`PhotoFilter` 枚举）
   - 不同图形类型的绘制策略（`AbstractShape` 及其子类）

5. **工厂模式**
   - `GraphicManager` 管理不同类型的图形元素

---

## 三、开发遇到的困难及解决思路


#### 3.1 多格式媒体支持

**问题**: 需要支持图片、GIF、WebP、视频等多种媒体格式。

**解决思路**:
- 使用 Glide 库自动处理 GIF 和 WebP 动画
- 通过 MIME 类型和文件扩展名判断媒体类型
- 为不同媒体类型提供不同的加载策略

**关键代码**（`MediaLoader.kt`）:

```kotlin
fun getMediaType(context: Context, uri: Uri): MediaType {
    val mimeType = context.contentResolver.getType(uri) ?: ""
    return when {
        mimeType.startsWith("image/gif") -> MediaType.GIF
        mimeType.startsWith("image/webp") -> MediaType.WEBP
        mimeType.startsWith("video/") -> MediaType.VIDEO
        mimeType.startsWith("image/") -> MediaType.IMAGE
        else -> {
            // 通过文件扩展名判断
            val path = uri.path ?: ""
            when {
                path.endsWith(".gif", ignoreCase = true) -> MediaType.GIF
                path.endsWith(".webp", ignoreCase = true) -> MediaType.WEBP
                path.endsWith(".mp4", ignoreCase = true) -> MediaType.VIDEO
                else -> MediaType.IMAGE
            }
        }
    }
}
```

#### 3.2 撤销/重做功能实现

**问题**: 需要实现复杂的撤销/重做机制，支持多种编辑操作。

**解决思路**:
- 使用命令模式记录每个编辑操作
- 维护操作历史栈（`PhotoEditorViewState`）
- 实现状态快照机制，支持快速恢复

**实现位置**: `photoeditor/src/main/java/ja/miniPE/photoeditor/PhotoEditorViewState.kt`

#### 3.3 触摸事件处理

**问题**: 需要处理复杂的多指触摸（缩放、旋转、拖拽），以及触摸事件冲突（画笔绘制 vs 元素操作）。

**解决思路**:
- 实现自定义 `MultiTouchListener`
- 使用 `ScaleGestureDetector` 处理缩放
- 正确处理触摸事件冲突

**实现位置**: `photoeditor/src/main/java/ja/miniPE/photoeditor/MultiTouchListener.kt`

#### 3.4 裁剪功能统一管理

**问题**: 需要统一管理从相机、图库选择图片并裁剪的流程。

**解决思路**:
- 使用单例模式的 `CropManager`
- 使用 `ActivityResultLauncher` 处理结果回调
- 提供统一的接口，简化调用

**关键代码**（`CropManager.kt`）:

```kotlin
class CropManager private constructor() {
    companion object {
        fun getInstance(): CropManager {
            return INSTANCE ?: synchronized(this) {
                INSTANCE ?: CropManager().also { INSTANCE = it }
            }
        }
    }
    
    fun build(activity: FragmentActivity) {
        // 注册各种 ActivityResultLauncher
        cameraLauncher = activity.registerForActivityResult(...)
        galleryLauncher = activity.registerForActivityResult(...)
        cropLauncher = activity.registerForActivityResult(...)
    }
    
    fun pickFromCamera() { ... }
    fun pickFromGallery() { ... }
    fun cropImage(uri: Uri) { ... }
}
```

---

### 四、项目总结

miniPE 项目成功实现了一个功能完整、性能优秀的 Android 图片编辑器。通过模块化架构设计、性能优化和异常处理，解决了大图片加载、内存溢出等关键问题，为用户提供了流畅的编辑体验。

**核心技术要点**:
- 模块化分层架构
- 图片采样加载和内存优化
- 异步加载和协程使用
- OOM 异常处理和降级策略
- 设计模式的合理应用

